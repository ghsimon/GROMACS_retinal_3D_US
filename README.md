# GROMACS umbrella sampling in retinal isomerization

This project contains the code and some of the generated data for 3D umbrella sampling (US) simulations for ground state trans-cis isomerization around the C13=C14 double bond in retinal cofactor attached to a constrained lysine dipeptide.

The intention is to calculate a three-dimensional diffusion profile in three collective variables (CV):
- dihedral angle for C13=C14 double bond along the polyene chain (*phi*)
- improper dihedral of out-of-plane bending of methyl group on C13 atom (*improper1*)
- improper dihedral of out-of-plane bending of hydrogen on C14 atom (*improper2*)

For details see: [Link to the paper](https://doi.org/10.48550/arXiv.2312.12948).

## Force field and starting structure

The force field files are included in the `amber99sb-star-ildn-retk.ff` folder. Retinal parameters for atomistic force field calculations were taken from DFT studies on the protonated Schiff base taken, [adapted to GROMACS format](http://cmb.bio.uni-goettingen.de/retinal_gromacs.html). The connecting amino acid was modelled using the [AMBER99SB*-ILDN forcefield](https://manual.gromacs.org/documentation/2019/user-guide/force-fields.html). 

Starting structure `6eid_capped_matched.gro` was obtained by cutting out the lysine amino acid and retinal cofactor from a [recent crystal structure](https://www.rcsb.org/structure/6EID), while the ends of the lysine were capped with methyl groups.

Corresponding topology file `topol.top` was generated by GROMACS. Position restraints are given in `posre6.itp` file.

## Generating trajectories

Starting structure is energy minimized using the `minim.mdp` input file, and the resulting structure is used in a series of 729 US windows localized at different values on a three-dimensional grid in the CV space. 
Each window will be biased by a three-dimensional harmonic restraint, localized on a grid in CV space ranging between -3.1 and 3.1 radians in 9 equidistant intervals along *phi* and between -1 radian and 1 radian in 9 equidistant intervals in both *improper1* and *improper2* directions. 

Each window is designated by three indices *i*, *j* and *k*, where *i* indexes the position of the corresponding harmonic restraint on the grid in *phi* direction (0-8), *j* indexes the position of the corresponding harmonic restraint on the grid in *improper1* direction (0-8) and *k* indexes the position of the corresponding harmonic restraint on the grid in *improper2* direction (0-8).

For each window, a two step NVT equilibration is performed starting from the energy minimized structure. 
- The first NVT equilibration run uses input files `eq1_nvt.mdp` for the dynamics and `plumed_input/eq1_plumed{i}{j}{k}.dat` for the biasing, where {i}, {j}, and {k} get the values of the corresponding indices for the window. The harmonic restraint is set to use a lower spring constant for the harmonic restraints as to ease the energy minimized structure towards the desired position in CV space.
- The second NVT equilibration run used input files `eq2_nvt.mdp` for the dynamics and `plumed_input/eq2_plumed{i}{j}{k}.dat` for the biasing, where {i}, {j}, and {k} get the values of the corresponding indices for the window. The harmonic restraint is set to use the same spring constant for the harmonic restraints as for the production runs so the simulation is equilibrated for the conditions at which the production runs take place.

Production runs use input files `md.mdp` for dynamics and `plumed_input/plumed{i}{j}{k}.dat` for the biasing, where again {i}, {j}, and {k} get the values of the corresponding indices for the window.

The two step equilibrations and production runs are carried out for each window in the `run_input/run{i}{j}{k}.sh` scripts. In the current implementation, they are done sequentially (though parallellization is straightforward).

## Parallellization

PLUMED input files for each of the 729 windows/trajectories are written by the `write_plumed_files.py` script and saved in the `plumed_input` directory. Input files governing the biasing for the first and second equilibration step are written out as `eq1_plumed{i}{j}{k}.dat` and `eq2_plumed{i}{j}{k}.dat` respectively, where {i}, {j}, and {k} get the values of the corresponding indices for the window. Input files governing the biasing for production runs are written out as `plumed{i}{j}{k}.dat`, where again {i}, {j}, and {k} get the values of the corresponding indices for the window.

Shell scripts to conduct single window simulations are written by the `write_run_files.py` script and saved in the `run_input` directory. Each script `run{i}{j}{k}.sh` carries out two equilibration steps and the production run for a single window (where again {i}, {j}, and {k} get the values of the corresponding indices), i.e. for a single harmonic restraint in the three-dimensional grid in CV space. The shell scripts are made to call the correct PLUMED input files at each stage. Each window is pinned to a single CPU, where assignment is governed in the shell scripts directly. 

In total, the 729 windows are divided over 45 CPUs, each CPU carrying out 16 windows sequentially. To do this, all sixteen `run_input/run{i}{j}{k}.sh` scripts assigned to the same CPU are listed in a single `mult/mult{n}.sh` script to be carried out sequentially, where {n} designates to the number of the assigned CPU (1-45). In this way, all 45 `mult/mult{n}.sh` scripts can be started in parallel and independently of one-other. The `mult/mult{n}.sh` shell scripts are written by running the `write_mult_files.py` script.

The `combine_mult?.sh` scripts bundle a number of `mult/mult{n}.sh` scripts for easy launching.

## Diffusion Profiles

Diffusion profiles are calculated using a multidimensional generalization of [Hummer's method](https://iopscience.iop.org/article/10.1088/1367-2630/7/1/034/pdf) in the `calculate_diffusion.py` script in the `Diffusion` directory.

## Command History

A history of the commands used is given in the `history.txt` file.

## Prerequisite Software 

 - GROMACS 2019.6 plugged with PLUMED
 - Python

## Deployment

COLVAR and trajectory files have been deleted.


